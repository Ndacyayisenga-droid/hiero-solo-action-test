name: Validate JSON-RPC Relay

on:
  pull_request:
    branches: [ master ]

jobs:
  validate-json-rpc-relay:
    runs-on: ubuntu-latest
    steps:
      - name: üöÄ Checkout Repo
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Hedera Solo with JSON-RPC-Relay
        uses: ./
        with:
          installRelay: true
        id: solo

      - name: ‚úÖ Validate JSON-RPC Relay
        run: |
          echo "Account ID: ${{ steps.solo.outputs.accountId }}"
          
          # Allow time for port-forwarding to establish
          sleep 15

          # Test eth_chainId method (local network chain ID is 0x127)
          RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            http://localhost:7546 \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}' \
            -o response.json)

          if [ "$RESPONSE" -ne 200 ]; then
            echo "‚ùå Error: Relay request failed (HTTP $RESPONSE)"
            cat response.json
            exit 1
          elif ! grep -q "0x127" response.json; then
            echo "‚ùå Error: Unexpected chain ID - expected local network (0x127)"
            cat response.json
            exit 1
          else
            echo "‚úÖ Relay operational - correct local chain ID detected"
            cat response.json
          fi